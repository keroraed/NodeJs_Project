import doctorRepository from "./doctor.repository.js";import appointmentRepository from "../appointments/appointment.repository.js";import ApiError from "../../core/errors/ApiError.js";import { VALID_STATUS_TRANSITIONS } from "../../core/config/constants.js";import {  getPagination,  paginatedResponse,} from "../../core/utils/pagination.util.js";class DoctorService {  async getOwnProfile(userId) {    const doctor = await doctorRepository.findByUserId(userId);    if (!doctor) {      throw ApiError.notFound("Doctor profile not found");    }    return doctor;  }  async updateProfile(userId, updateData) {    const doctor = await doctorRepository.findByUserId(userId);    if (!doctor) {      throw ApiError.notFound("Doctor profile not found");    }    return doctorRepository.updateByUserId(userId, updateData);  }  async getOwnAppointments(userId, query) {    const doctor = await doctorRepository.findByUserId(userId);    if (!doctor) {      throw ApiError.notFound("Doctor profile not found");    }    const { page, limit, skip } = getPagination(query);    const filter = {};    if (query.status) {      filter.status = query.status;    }    const { appointments, total } = await appointmentRepository.findByDoctor(      doctor._id,      filter,      skip,      limit,    );    return paginatedResponse(appointments, total, page, limit);  }  async updateAppointment(userId, appointmentId, updateData) {    const doctor = await doctorRepository.findByUserId(userId);    if (!doctor) {      throw ApiError.notFound("Doctor profile not found");    }    const appointment = await appointmentRepository.findOneByIdAndDoctor(      appointmentId,      doctor._id,    );    if (!appointment) {      throw ApiError.notFound("Appointment not found");    }    if (updateData.status) {      const allowedTransitions = VALID_STATUS_TRANSITIONS[appointment.status];      if (        !allowedTransitions ||        !allowedTransitions.includes(updateData.status)      ) {        throw ApiError.badRequest(          `Cannot transition from '${appointment.status}' to '${updateData.status}'`,        );      }      appointment.status = updateData.status;    }    if (updateData.notes !== undefined) {      appointment.notes = updateData.notes;    }    await appointment.save();    return appointment;  }  async uploadProfilePicture(userId, file) {    if (!file) {      throw ApiError.badRequest("No image file provided");    }    const doctor = await doctorRepository.findByUserId(userId);    if (!doctor) {      throw ApiError.notFound("Doctor profile not found");    }    const profilePicture = `/uploads/profiles/${file.filename}`;    return doctorRepository.updateByUserId(userId, { profilePicture });  }  async listApprovedDoctors(query) {    const { page, limit, skip } = getPagination(query);    const filter = {};    if (query.specialty) {      filter.specialty = query.specialty;    }    const { doctors, total } = await doctorRepository.findAllApproved(      filter,      skip,      limit,      query.name || "",    );    return paginatedResponse(doctors, total, page, limit);  }  async listAllDoctors(query) {    const { page, limit, skip } = getPagination(query);    const { doctors, total } = await doctorRepository.findAll(      {},      skip,      limit,      query.name || "",    );    return paginatedResponse(doctors, total, page, limit);  }  async getDoctorById(doctorId) {    const doctor = await doctorRepository.findById(doctorId);    if (!doctor) {      throw ApiError.notFound("Doctor not found");    }    return doctor;  }  async getDoctorAvailability(doctorId) {    const doctor = await doctorRepository.findById(doctorId);    if (!doctor) {      throw ApiError.notFound("Doctor not found");    }    return doctor.availability;  }}export default new DoctorService();